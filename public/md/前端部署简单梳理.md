## 一、前言

初入职场时，还没有devops的概念，前端的开发包括了手动构建与手动部署上线的过程，虽然学得很艰难，但也是一笔宝贵的财富，如今虽然不需要再手动做这些事了，但也要对流程有个概念，出了问题不至于一头雾水

## 二、部署流程

### 1、部署所需要的东西

- 前端构建打包好的代码

  即dist文件夹

- xshell

  linux的远程连接工具（有替代品，secureCRT，还挺好用的）

- xftp

  与xshell相配合的传输文件的工具（主要用于上传dist文件夹）

### 2、一套组合拳

- 首先通过`xshell`连接到服务器
- 然后在服务器中创建自己的文件夹（注意修改用户和用户群组）
- 将`dist`文件夹和`Dockerfile`、`nginx.conf`文件放到自己的文件夹中
- 直接开始打镜像（非常简单，一句命令的事，但需要注意端口等参数）`docker build`
- 启动镜像 `docker run`

## 三、Dockerfile配置文件

Dockerfile是由一系列命令和参数构成的脚本，这些命令应用于基础镜像并最终创建一个新的镜像。

```bash
  # 指定了基础镜像为nginx。它表示我们将在该基础镜像的基础上构建我们自己的镜像。
  FROM nginx

  # 将本地主机上的nginx.conf文件复制到容器内的/etc/nginx/nginx.conf路径下。它用于替换默认的Nginx配置文件，以便自定义Nginx服务器的配置。
  COPY nginx.conf /etc/nginx/nginx.conf

  # 将本地主机上的dist/目录中的内容复制到容器内的/etc/nginx/html/manage路径下。它用于将静态资源文件（如HTML、CSS、JavaScript等）复制到Nginx服务器所使用的目录中，以便在浏览器中访问这些静态资源。
  # 注意一般没有后面那个manage，带前缀的项目才需要多配一级目录
  COPY dist/ /etc/nginx/html/manage
```

## 四、nginx配置文件

Nginx是一个反向代理服务器

提到nginx，就不得不提到反向代理，那么我们浅区分一下正向代理和反向代理：

> 正向代理代理的是用户，用户去访问想访问的网站（**知道具体地址**），然后代理服务器会代替用户去请求，因为用户本身可能并没有访问的权限，正向代理的最佳例子就是科学上网工具；反向代理代理的是服务器，**用户不知道想访问的网站是什么**，但知道通过哪台服务器能访问得到它，因为代理服务器会代替服务器接收用户的请求，把请求最终转发给真正的服务器，比如proxy

### 1、gzip压缩配置

gzip的压缩有两种情况：

- 服务端响应请求时候压缩，前端不做其他配置，只需要nginx配置
- 前端配置gzip，使得打包构建时就压缩好，配合nginx配置`gzip_static on;`，服务端响应请求时候只需调取对应的gz文件

注意，这两种情况在项目不大的时候几乎没有区别，但一旦项目体积很大，推荐使用第二种，能够明显减轻服务器压力

### 2、nginx的坑

服务器上不止一层nginx代理，除了我们自己项目文件夹下的nginx配置，还有外层nginx也需要开启一些配置才能生效

比如gzip配置，外层nginx相当于大门，浏览器对接的是它，如果他关上了gzip的门，那么里面开启不会生效（更改ngxin时跟后端说一下外层也要改就是了）

### 3、重要配置

```js
 server {
        # 静态资源目录，404出错来源
        # 这里的命名需与域名一致
        location /manage/ {
            ...
            #注意这个@router
            try_files $uri $uri/ @router;
            ...
        }

        location @router {
            # 这里与Dockerfile中的目录命名要一致，但与域名可以不一致
            rewrite ^.*$ /manage/index.html break;
        }

        # 代理
        location ~ /api/ {
             proxy_pass  http://10.39.174.36:38201;
               # 重写URL 去除api
            rewrite "^/api/(.*)$" /$1 break;
        }
    }
```

## 五、devops部署流程梳理

`后端需要做的就是配置好域名`

- 第一步：在项目代码中加上nginx配置和Dockerfile文件

- 第二步：克隆管道，修改其中的配置

  - 修改获取源

    ![ ](/md/前端部署简单梳理/1.png)

  - 修改docker项目名称（变量形式，自定义就好，这个名称似乎后端拿来有用，所以要跟后端同步一下）

    ![ ](/md/前端部署简单梳理/2.png)

- 第三步：克隆发布，修改其中的配置

  注意管道只是生成了一个包，还没有连接到服务器，还需要发布

  <mark>如果管道跑了很久也没成功，可以在发布的那里选一个发成功的管道发布</mark>

  - 修改SSH服务连接（后端提供，这一步决定了前端代码发布到哪台服务器上）

    ![ ](/md/前端部署简单梳理/6.png)

  - 修改docker项目名称（与管道命名匹配）

    <mark>有时候发布会遇到报错，该容器名称已被占用，说明前一次发布时失败了，但容器遗留在服务器，需要让后端帮忙清理一下，或者还有一种解决方法就是换一个没用过的名字</mark>

    ![ ](/md/前端部署简单梳理/3.png)

  - 修改产物名称（这个名称的命名是自定义的，但要保持一致）

    ![ ](/md/前端部署简单梳理/4.png)

  - 修改端口号（因为这个发布是克隆的，所以不能使用相同的端口号，否则会把其他的项目覆盖掉，不过如果服务器换了就没关系）

    ![ ](/md/前端部署简单梳理/5.png)

    这个端口号需要跟后端同步，后端用于配置服务器ng转发，相当于指向前端的镜像，如果后端没有这个配置，前端的ng也不会生效

    ![ ](/md/前端部署简单梳理/7.png)

- 第四步：线上bug

  如果出现了紧急的线上bug，且无法及时解决，可以先回退到上一个可用的发布，应急
