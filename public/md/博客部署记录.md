### 前言

博客部署终于排上了日程，选择了github托管，方便快捷，不过遇到的问题也不少，在此做个记录

### 博客部署记录

#### 1、更改打包目录

github pages部署**前端框架**时，使用的源是docs文件夹，把原本的dist文件夹更名即可，无论用什么前端框架，部署需要的都是打包后的文件

```js
// .umirc.prod.ts
outputPath: 'docs',
```

#### 2、github配置

进入仓库的setting，注意仓库必须是public仓库，进入pages设置，主要选项如下：

```bash
source: 'deploy from branch'
Branch: main docs
```

配置完后，会以仓库名为前缀生成一个网站，如本站的仓库名为`chushanxue`，那么网站地址为`https://chushanxue.github.io/chushanxue/`

#### 3、umi配置

继续回到项目，设置相同的前缀

```js
// .umirc.prod.ts
 base: '/chushanxue/',
 publicPath: '/chushanxue/',
```

#### 4、静态资源路径配置

做好上面三步，网页就能正常上线了，但请求静态资源时不会带上前缀，导致404，这个问题在umi的配置中有讲到，原因是放在public文件夹下的静态资源不会自动带上前缀，所以得处理前端代码，有两种情况，一是ts类型的文件，二是样式文件

```js
// 检测当前的环境，返回不同的前缀
export const useBasePath = () => {
  const { NODE_ENV } = process.env;
  if (NODE_ENV === 'development') {
    return '';
  }
  return '/chushanxue';
};

<img src={useBasePath() + '/img/logo/logo3.svg'} />;
```

样式文件很简单，本来不知道如何在css中插入变量，其实不需要，直接写两个地址即可，一个请求不到自然会去请求另外一个

```css
@font-face {
  font-family: GEORGIA;
  src: url('/chushanxue/fonts/GEORGIA.ttf'), url('/fonts/GEORGIA.ttf');
  font-style: normal;
  font-stretch: ultra-expanded;
}
```

#### 5、页面刷新404

Umi 项目本地运行刷新没问题，但是部署之后刷新页面报404。因为Umi 默认是用 browser 模式，需要做一下处理。

```bash
在Umi项目中，"browser"模式是指Umi默认使用的一种路由模式。在这种模式下，Umi会根据浏览器的URL路径来匹配对应的页面组件，并进行渲染。这意味着在部署项目后，如果直接刷新页面，可能会导致404错误，因为服务器无法找到对应的路由。
```

找到了两种方案，但只有第二种有效

```js
// .umirc.prod.ts
// history: { type: 'hash' },
exportStatic: {},
```

#### 6、获取上次部署时间

现在的博客是纯前端，借用github的page功能部署，有一个功能是判断博客更新的时间，之前的写法是：

```tsx
 <p className={styles['slogan']}>
    {!updateTime && Locale.Home.Slogan}
    {!updateTime && <SmileTwoTone twoToneColor="#52c41a" />}
    {updateTime && 已经${updateTime}天没有更新博客啦}
    {updateTime && <FrownTwoTone twoToneColor="#faa219" />}
  </p>
```

```js
const [updateTime, setUpdateTime] = useState < any > false;
useMount(() => {
  setUpdateTime(useUpdateTime());
});

//以下是useUpdateTime的内容：
// 导入posts数据
import posts from '@/models/data/posts.json';
export const useUpdateTime = () => {
  // 获取当前日期
  const currentDate = new Date();
  currentDate.setHours(0, 0, 0, 0); // 将时分秒设置为0

  // 获取第一条post的日期
  const firstPostDate = new Date(posts[0].time);

  // 计算相隔的天数
  const timeDiff = Math.abs(currentDate.getTime() - firstPostDate.getTime());
  const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

  // 判断是否为同一天
  if (currentDate.toDateString() === firstPostDate.toDateString()) {
    console.log(true);
    return false;
  } else {
    console.log(daysDiff);
    return daysDiff;
  }
};
```

但是这个方法只能判断有没有新增文章，而不能判断现有文章有没有更新，所以在纯前端的前提下，只判断部署时间，以有没有重新部署作为更新文章的判断依据

```js
useEffect(() => {
  const fetchDeploymentTime = async () => {
    // 返回最后一次部署的时间
    const response = await fetch(
      'https://api.github.com/repos/你的用户名/你的仓库名/commits',
      {
        headers: {
          Authorization: 'Bearer 你的Personal Access Token',
        },
      },
    );
    const data = await response.json();
    const lastCommit = data[0]; // 获取最近的提交信息
    const commitDate = new Date(lastCommit.commit.committer.date);
    // 格式化时间
    const formattedDate = commitDate.toLocaleString();
    // 计算与今天相隔的天数以及是不是今天
    const today = new Date();
    const timeDiff = today.getTime() - commitDate.getTime();
    const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24))
      ? Math.floor(timeDiff / (1000 * 60 * 60 * 24))
      : false;

    setUpdateTime(daysDiff);
  };

  fetchDeploymentTime();
}, []);
```

<mark>这个方法的关键在于使用GitHub提供的GitHub API，通过获取最近的提交时间来判断是否有更新。</mark>

- 需要知道用哪个api
- 需要认证GitHub API请求

  github地址：https://github.com/settings/tokens?type=beta

  起一个Token name，以及注意Expiration就行，这个以前操作过，所以有经验，注意只能复制一次

### 其他问题

1、更改账号名

github更改了账号名，导致本机与github的关联关系丢失，需要重新配置

- 查看本地是否存在 SSH密钥 打开node命令行 输入ls -al ~/.ssh

  `看是否存在id_rsa和id_rsa.pub，有的话直接跳到第三步`

- 生成SSH密钥

  `命令：ssh-keygen -t rsa -C “自己的Email地址” 注意：执行完成后会有一些列提示输入密码的指令，直接回车即可`

- 查看SSH公钥

  `命令：cat /Users/电脑用户名/.ssh/id_rsa.pub`

- GitHub添加本机SSH Key

  `打开网址：https://github.com/settings/ssh/new`

2、接口跨域问题

本地遇到跨域问题，用到的是proxy代理，本质上是本地开启的一台服务器

而github的gh-pages只是个静态页面展示，没有服务器功能，服务器需要自己搭, 然后把服务器地址放到gh-pages里。（这里暂时不去深究）

### 后记

很久没有像这样攻克一个课题了，仿佛又回到了一两年前刚踏足前端的时候，纯粹地因为解决了问题而成就感满满。

被工作磋磨的这段日子，对技术的热情在慢慢衰退，甚至有时候觉得我好像并不喜欢自己的工作，但今日重拾心情，发现，我是真的喜欢前端，我不喜欢的只是工作中遇到的讨厌的人和事，以及围绕工作制度的各种烦恼

最近的热门话题，AI总会替代掉一部分前端，即便如此，我们在过程中学到的专注、坚持，才是真正无法被AI所替代的，也许像有些悲观主义者说的那样，现在还学技术有什么用，反正早晚会被优化，但我现在好像找到了新的答案，就像人生一样，不用追求结果有何意义，过程才是最重要的，即便知道AI横亘在不久的将来，也至少把握好现在。

### 引用

> [Umi - 刷新后页面报404](https://blog.csdn.net/kelly0721/article/details/127979088)[使用 github pages, 快速部署你的静态网页](https://github.com/ssthouse/ssthouse-blog/blob/master/use-github-page-efficiently/blog.md)[git@github.com: Permission denied (publickey). fatal: 无法读取远程仓库。 请确认您有正确的访问权限并且仓](https://juejin.cn/post/7128286174317117476)
